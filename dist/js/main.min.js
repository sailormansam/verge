var Block=function(t,e,i,s,a){e+=.5,i+=.5,this.parent=t,this.sprite,this.width=s,this.height=s,this.x=e*this.width,this.y=i*this.height,this.type=a,this.create()};Block.prototype={create:function(){var t=game.add.graphics(0,0);this.type==blockType.STATIC?t.beginFill(6710886):t.beginFill(10066329),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),game.physics.p2.enable(this.sprite),this.sprite.body.dynamic=!1,this.sprite.body.setCollisionGroup(this.parent.blockCollisionGroup),this.sprite.body.collides([this.parent.blockCollisionGroup,this.parent.playerCollisionGroup])}};var GameStates=GameStates||{},textStyle={normal:{font:"3em squada one",fill:"#333"},large:{font:"6em squada one",fill:"#333"}};GameStates.Boot=function(t){},GameStates.Boot.prototype={init:function(){this.input.maxPointers=1,game.stage.backgroundColor="#ffffff",game.canvas.oncontextmenu=function(t){t.preventDefault()}},create:function(){game.state.start("Preloader")}};var blockType={STATIC:"STATIC",MOVEABLE:"MOVEABLE"};GameStates.Game=function(t){this.player,this.level,this.block=[],this.teleporter,this.map,this.graphics,this.originPointer,this.mapGrain=40,this.worldBottomPadding=300,this.playerCollisionGroup,this.blockCollisionGroup,this.blockLayer,this.GRAVITY=1e3,this.FALL_BUFFER=200},GameStates.Game.prototype={create:function(){this.player=null,this.level=0,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.defaultRestitution=1,game.physics.p2.gravity.y=this.GRAVITY,game.physics.p2.damping=1,game.physics.p2.setImpactEvents(!0),this.playerCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockCollisionGroup=game.physics.p2.createCollisionGroup(),this.map=JSON.parse(JSON.stringify(game.cache.getJSON("map"))),this.blockLayer=game.add.group(),this.graphics=game.add.graphics(0,0),this.graphics.alpha=.5,this.makeLevel(this.level),game.camera.follow(this.player.sprite),game.input.mouse.capture=!0,this.player.sprite.body.collides(this.blockCollisionGroup,this.player.checkJump,this.player)},update:function(){if(this.player.update(),game.input.activePointer.leftButton.isDown&&this.placeBlock(game.input),this.graphics.clear(),game.input.activePointer.rightButton.isDown)null==this.originPointer&&(this.originPointer={x:game.input.x,y:game.input.y}),this.drawNet(game.input);else{if(null!=this.originPointer){var t={x:null,y:null},e={x:null,y:null};this.originPointer.x<game.input.x?(t.x=this.originPointer.x,e.x=game.input.x):(t.x=game.input.x,e.x=this.originPointer.x),this.originPointer.y<game.input.y?(t.y=this.originPointer.y,e.y=game.input.y):(t.y=game.input.y,e.y=this.originPointer.y);for(var i=new Phaser.Rectangle(t.x,t.y,e.x-t.x,e.y-t.y),s=0,a=this.block.length;a>s;s++)null!=this.block[s]&&this.player.inventory.count<this.player.inventory.CAP&&this.block[s].type==blockType.MOVEABLE&&Phaser.Rectangle.intersects(this.block[s].sprite.getBounds(),i)&&(this.block[s].sprite.destroy(),this.block[s]=null,this.player.inventory.change(1))}this.originPointer=null}Phaser.Rectangle.intersects(this.player.sprite.getBounds(),this.teleporter.sprite.getBounds())&&(this.map.level[this.level+1]?this.makeLevel(this.level++):game.state.start("GameOver")),this.player.sprite.body.y>game.world.height+this.worldBottomPadding+this.player.sprite.height&&this.makeLevel(this.level)},preRender:function(){this.player.preRender()},placeBlock:function(t){for(var e={x:Math.floor((t.x+game.camera.x)/this.mapGrain),y:Math.floor((t.y+game.camera.y)/this.mapGrain)},i=0,s=this.block.length;s>i;i++)if(null!=this.block[i]&&this.block[i].x==(e.x+.5)*this.mapGrain&&this.block[i].y==(e.y+.5)*this.mapGrain)return;if(this.player.inventory.count>0){var a=new Block(this,e.x,e.y,this.mapGrain,blockType.MOVEABLE);this.block.push(a),this.blockLayer.add(a.sprite),this.player.inventory.change(-1)}},drawNet:function(t){this.graphics.beginFill(16711680),this.graphics.drawRect(this.camera.x+this.originPointer.x,this.camera.y+this.originPointer.y,t.x-this.originPointer.x,t.y-this.originPointer.y)},makeLevel:function(){this.block.forEach(function(t){null!=t&&t.sprite.destroy()}),this.block=[],this.teleporter&&this.teleporter.sprite.destroy(),this.player?this.player.moveToStart(this.map.level[this.level].start.x*this.mapGrain+.5,this.map.level[this.level].start.y*this.mapGrain+.5):this.player=new Player(this,this.map.level[this.level].start.x*this.mapGrain+.5,this.map.level[this.level].start.y*this.mapGrain+.5),this.player.inventory.clear();for(var t=0,e=this.map.level[this.level].block.length;e>t;t++)this.block.push(new Block(this,this.map.level[this.level].block[t].x,this.map.level[this.level].block[t].y,this.mapGrain,this.map.level[this.level].block[t].type));this.teleporter=new Teleporter(this.map.level[this.level].teleporter.x,this.map.level[this.level].teleporter.y,this.mapGrain);for(var i=0,s=0,t=0,e=this.block.length;e>t;t++)this.block[t].x>i&&(i=this.block[t].x),this.block[t].y>s&&(s=this.block[t].y);i<game.width&&(i=game.width),s<game.height&&(s=game.height),game.world.setBounds(0,0,i+this.mapGrain/2,s+this.FALL_BUFFER)}},GameStates.GameOver=function(t){},GameStates.GameOver.prototype={create:function(){this.titleText=game.add.text(.25*game.width,.5*game.height,"THE END",textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY AGAIN",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0);var t=game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);t.onComplete.add(function(){game.state.start("Game")},this)}};var Inventory=function(){this.count=0,this.CAP=5,this.sprite=null,this.blockWidth=20,this.blockHeight=20,this.x=0,this.y=0,this.paddingX=-20,this.paddingY=-45,this.create()};Inventory.prototype={create:function(){this.drawCount()},preRender:function(t){this.x=t.sprite.body.x,this.y=t.sprite.body.y,this.positionSprite()},change:function(t){this.count+=t,this.drawCount()},clear:function(){this.count=0,this.drawCount()},drawCount:function(){this.sprite&&this.sprite.destroy();var t=game.add.graphics(0,0);t.beginFill(10066329);for(var e=0;e<this.count;e++)t.drawRect(e*(this.blockWidth+5),0,this.blockWidth,this.blockHeight);this.sprite=game.add.sprite(this.x+this.paddingX,this.y+this.paddingY,t.generateTexture()),this.positionSprite(),t.destroy()},positionSprite:function(){var t=this.sprite.width||0;this.sprite.x=this.x+this.paddingX-t,this.sprite.y=this.y+this.paddingY}},GameStates.MainMenu=function(t){this.titleText,this.playText},GameStates.MainMenu.prototype={create:function(){this.titleText=game.add.text(.25*game.width,game.world.centerY,"VERGE",textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0);var t=game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);t.onComplete.add(function(){game.state.start("Game")},this)}};var Player=function(t,e,i){this.parent=t,this.sprite,this.x=e,this.y=i,this.width=25,this.height=40,this.canJump=!1,this.jumpKeyUp=!1,this.continueJump=!1,this.ACCELERATION=50,this.MAX_SPEED=300,this.JUMP=-450,this.IN_AIR_SPEED=.3,this.create()};Player.prototype={create:function(){var t=game.add.graphics(0,0);t.beginFill(3355443),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),game.physics.p2.enable(this.sprite),this.sprite.body.mass=1,this.sprite.body.setCollisionGroup(this.parent.playerCollisionGroup),this.inventory=new Inventory(this.parent)},preRender:function(){this.inventory.preRender(this)},update:function(){this.sprite.body.setZeroRotation(),this.sprite.body.rotation=0,this.move(),game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?this.jumpKeyUp=!1:this.jumpKeyUp=!0},move:function(){var t=1;this.canJump||(t=this.IN_AIR_SPEED),game.input.keyboard.isDown(Phaser.Keyboard.A)||game.input.keyboard.isDown(Phaser.Keyboard.LEFT)?this.sprite.body.velocity.x+=-this.ACCELERATION*t:(game.input.keyboard.isDown(Phaser.Keyboard.D)||game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))&&(this.sprite.body.velocity.x+=this.ACCELERATION*t),this.sprite.body.velocity.x>this.MAX_SPEED&&(this.sprite.body.velocity.x=this.MAX_SPEED),this.sprite.body.velocity.x<-this.MAX_SPEED&&(this.sprite.body.velocity.x=-this.MAX_SPEED),(game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP))&&(this.canJump&&this.jumpKeyUp||this.continueJump)&&(this.sprite.body.velocity.y=this.JUMP,this.continueJump=!0,game.time.events.add(Phaser.Timer.SECOND/4,this.stopJump,this).autoDestroy=!0)},stopJump:function(){this.continueJump=!1},moveToStart:function(t,e){this.sprite.body.x=t,this.sprite.body.y=e,this.sprite.body.velocity.x=0,this.sprite.body.velocity.y=0},checkJump:function(){this.canJump=!0}},GameStates.Preloader=function(t){},GameStates.Preloader.prototype={preload:function(){var t=game.add.text(.2*game.width,game.world.centerY,"LOADING",textStyle.large);t.anchor.set(0,.5),game.load.json("map","../map.json")},create:function(){game.state.start("MainMenu")}};var Teleporter=function(t,e,i){t+=.5,e+=.5,this.sprite,this.width=i,this.height=i,this.x=t*this.width,this.y=e*this.height,this.create()};Teleporter.prototype={create:function(){var t=game.add.graphics(0,0);t.beginFill(16711680),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),this.sprite.anchor.set(.5)}};