var Block=function(t,e,i,a,s){e+=.5,i+=.5,this.gameState=t,this.material=s;var o=game.add.graphics(0,0);this.material==blockType.STATIC?o.beginFill(6710886):o.beginFill(10066329),o.drawRect(0,0,a,a),Phaser.Sprite.call(this,game,e*a,i*a,o.generateTexture()),game.add.existing(this),o.destroy(),this.create()};Block.prototype=Object.create(Phaser.Sprite.prototype),Block.prototype.constructor=Block,Block.prototype.create=function(){game.physics.p2.enable(this),this.body.dynamic=!1,this.body.setCollisionGroup(this.gameState.blockCollisionGroup),this.body.collides([this.gameState.blockCollisionGroup,this.gameState.playerCollisionGroup])};var GameStates=GameStates||{},textStyle={normal:{font:"3em squada one",fill:"#333"},large:{font:"6em squada one",fill:"#333"}};GameStates.Boot=function(t){},GameStates.Boot.prototype={init:function(){this.input.maxPointers=1,game.stage.backgroundColor="#ffffff",game.canvas.oncontextmenu=function(t){t.preventDefault()}},create:function(){game.state.start("Preloader")}},GameStates.Editor=function(t){this.player,this.level,this.block=[],this.teleporter,this.map,this.graphics,this.originPointer,this.mapGrain=40,this.worldBottomPadding=300,this.playerCollisionGroup,this.blockCollisionGroup,this.timer,this.mapButton,this.blockLayer,this.GRAVITY=0,this.FALL_BUFFER=200},GameStates.Editor.prototype={create:function(){this.player=null,this.level=0,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.defaultRestitution=1,game.physics.p2.gravity.y=this.GRAVITY,game.physics.p2.damping=1,game.physics.p2.setImpactEvents(!0),this.playerCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockLayer=game.add.group(),this.graphics=game.add.graphics(0,0),this.graphics.alpha=.5,game.input.mouse.capture=!0,game.world.setBounds(0,0,2048,2048),this.mapButton=game.input.keyboard.addKey(Phaser.Keyboard.ENTER),this.mapButton.onDown.add(this.saveMap,this)},update:function(){game.input.activePointer.leftButton.isDown&&this.placeBlock(game.input),game.input.keyboard.isDown(Phaser.Keyboard.A)||game.input.keyboard.isDown(Phaser.Keyboard.LEFT)?game.camera.x-=5:(game.input.keyboard.isDown(Phaser.Keyboard.D)||game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))&&(game.camera.x+=5),game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?game.camera.y-=5:(game.input.keyboard.isDown(Phaser.Keyboard.S)||game.input.keyboard.isDown(Phaser.Keyboard.DOWN))&&(game.camera.y+=5)},preRender:function(){if(this.graphics.clear(),game.input.activePointer.rightButton.isDown)null==this.originPointer&&(this.originPointer={x:game.input.x,y:game.input.y}),this.drawNet(game.input);else{if(null!=this.originPointer){var t={x:null,y:null},e={x:null,y:null};this.originPointer.x<game.input.x?(t.x=this.originPointer.x,e.x=game.input.x):(t.x=game.input.x,e.x=this.originPointer.x),this.originPointer.y<game.input.y?(t.y=this.originPointer.y,e.y=game.input.y):(t.y=game.input.y,e.y=this.originPointer.y);for(var i=new Phaser.Rectangle(t.x,t.y,e.x-t.x,e.y-t.y),a=0,s=this.block.length;s>a;a++)null!=this.block[a]&&this.player.inventory.count<this.player.inventory.CAP&&this.block[a].type==blockType.DYNAMIC&&Phaser.Rectangle.intersects(this.block[a].getBounds(),i)&&(this.block[a].destroy(),this.block[a]=null,this.player.inventory.change(1))}this.originPointer=null}},placeBlock:function(t){for(var e={x:Math.floor((t.x+game.camera.x)/this.mapGrain),y:Math.floor((t.y+game.camera.y)/this.mapGrain)},i=0,a=this.block.length;a>i;i++)if(null!=this.block[i]&&this.block[i].x==(e.x+.5)*this.mapGrain&&this.block[i].y==(e.y+.5)*this.mapGrain)return;var s=new Block(this,e.x,e.y,this.mapGrain,blockType.DYNAMIC);this.block.push(s),this.blockLayer.add(s)},drawNet:function(t){this.graphics.beginFill(16711680),this.graphics.drawRect(this.camera.x+this.originPointer.x,this.camera.y+this.originPointer.y,t.x-this.originPointer.x,t.y-this.originPointer.y)},saveMap:function(){for(var t=[],e=0,i=this.block.length;i>e;e++)t.push({type:"STATIC",x:this.block[e].x,y:this.block[e].y});console.log(JSON.stringify({block:t}))}};var blockType={STATIC:"STATIC",DYNAMIC:"DYNAMIC"};GameStates.Game=function(t){this.player,this.map,this.teleporter,this.timer,this.pointerController,this.playerCollisionGroup,this.blockCollisionGroup,this.GRAVITY=1e3},GameStates.Game.prototype={create:function(){this.player=null,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.defaultRestitution=1,game.physics.p2.gravity.y=this.GRAVITY,game.physics.p2.damping=1,game.physics.p2.setImpactEvents(!0),this.playerCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockCollisionGroup=game.physics.p2.createCollisionGroup(),this.map=new Map(this),this.pointerController=new PointerController(this),this.player.body.collides(this.blockCollisionGroup,this.player.checkJump,this.player),this.timer=new Timer(game,game.width-60,20)},preRender:function(){this.pointerController.preRender()},update:function(){this.timer.update(game.time.elapsedMS),this.pointerController.update(),Phaser.Rectangle.intersects(this.player.getBounds(),this.teleporter.getBounds())&&(this.map.hasNextLevel()?(this.map.incrementLevel(),this.map.createCurrentLevel(),this.player.canMove=!1):game.state.start("GameOver")),this.player.body.y>game.world.height+this.map.WORLD_PADDING_BOTTOM+this.player.height&&this.map.createCurrentLevel()}},GameStates.GameOver=function(t){},GameStates.GameOver.prototype={create:function(){this.titleText=game.add.text(.25*game.width,.5*game.height,"TIME "+(time/1e3).toFixed(0).toString(),textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY AGAIN",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0);var t=game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);t.onComplete.add(function(){game.state.start("Game")},this)}};var Inventory=function(t){this.isEditor=t,this.isEditor?(this.count=512,this.CAP=512):(this.count=0,this.CAP=5),this.sprite=null,this.blockWidth=20,this.blockHeight=20,this.x=0,this.y=0,this.paddingX=-20,this.paddingY=-45,this.create()};Inventory.prototype={create:function(){this.isEditor||this.drawCount()},preRender:function(t){this.isEditor||(this.x=t.body.x,this.y=t.body.y,this.positionSprite())},change:function(t){this.count+=t,this.drawCount()},clear:function(){this.count=0,this.drawCount()},drawCount:function(){this.sprite&&this.sprite.destroy();var t=game.add.graphics(0,0);t.beginFill(10066329);for(var e=0;e<this.count;e++)t.drawRect(e*(this.blockWidth+5),0,this.blockWidth,this.blockHeight);this.sprite=game.add.sprite(this.x+this.paddingX,this.y+this.paddingY,t.generateTexture()),this.positionSprite(),t.destroy()},positionSprite:function(){var t=this.sprite.width||0;this.sprite.x=this.x+this.paddingX-t,this.sprite.y=this.y+this.paddingY}},GameStates.MainMenu=function(t){this.titleText,this.playText,this.editor},GameStates.MainMenu.prototype={create:function(){this.titleText=game.add.text(.25*game.width,game.world.centerY,"VERGE",textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,this.editor=game.add.text(.25*game.width,.7*game.height,"EDITOR",textStyle.normal),this.editor.anchor.set(0,.5),this.editor.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),game.add.tween(this.editor).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this),this.editor.inputEnabled=!0,this.editor.input.useHandCursor=!0,this.editor.events.onInputDown.add(this.playEditor,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);var t=game.add.tween(this.editor).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400);t.onComplete.add(function(){game.state.start("Game")},this)},playEditor:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);var t=game.add.tween(this.editor).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400);t.onComplete.add(function(){game.state.start("Editor")},this)}};var Map=function(t){this.gameState=t,this.blocks,this.data,this.level,this.blockLayer,this.WORLD_PADDING_BOTTOM=300,this.MAP_GRAIN=40,this.FALL_BUFFER=200,this.create()};Map.prototype={create:function(){this.blocks=[],this.level=0,this.data=JSON.parse(JSON.stringify(game.cache.getJSON("map"))),this.blockLayer=game.add.group(),this.createCurrentLevel()},hasNextLevel:function(){return this.data.level[this.level+1]},incrementLevel:function(){this.level++},createCurrentLevel:function(){game.world.alpha=0,this.blocks.forEach(function(t){null!=t&&t.destroy()}),this.blocks=[],this.gameState.teleporter&&this.gameState.teleporter.destroy(),this.gameState.player?this.gameState.player.moveToStart(this.data.level[this.level].start.x*this.MAP_GRAIN+.5,this.data.level[this.level].start.y*this.MAP_GRAIN+.5):this.gameState.player=new Player(this.gameState,this.data.level[this.level].start.x*this.MAP_GRAIN+.5,this.data.level[this.level].start.y*this.MAP_GRAIN+.5),this.gameState.player.inventory.clear();for(var t=0,e=this.data.level[this.level].blocks.length;e>t;t++)this.blocks.push(new Block(this.gameState,this.data.level[this.level].blocks[t].x,this.data.level[this.level].blocks[t].y,this.MAP_GRAIN,this.data.level[this.level].blocks[t].material));this.gameState.teleporter=new Teleporter(this.data.level[this.level].teleporter.x,this.data.level[this.level].teleporter.y,this.MAP_GRAIN);for(var i=0,a=0,t=0,e=this.blocks.length;e>t;t++)this.blocks[t].x>i&&(i=this.blocks[t].x),this.blocks[t].y>a&&(a=this.blocks[t].y);i<game.width&&(i=game.width),a<game.height&&(a=game.height),game.world.setBounds(0,0,i+this.MAP_GRAIN/2,a+this.FALL_BUFFER),game.camera.follow(null),game.camera.x=20,game.add.tween(game.world).to({alpha:1},500).start();var s=game.add.tween(game.camera).to({x:0},300);s.start(),s.onComplete.add(function(){game.camera.follow(this.gameState.player)},this)},placeBlock:function(t){for(var e={x:Math.floor((t.x+game.camera.x)/this.MAP_GRAIN),y:Math.floor((t.y+game.camera.y)/this.MAP_GRAIN)},i=0,a=this.blocks.length;a>i;i++)if(null!=this.blocks[i]&&this.blocks[i].x==(e.x+.5)*this.MAP_GRAIN&&this.blocks[i].y==(e.y+.5)*this.MAP_GRAIN)return;if(this.gameState.player.inventory.count>0){var s=new Block(this.gameState,e.x,e.y,this.MAP_GRAIN,blockType.DYNAMIC);this.blocks.push(s),this.blockLayer.add(s),this.gameState.player.inventory.change(-1)}},removeBlocksWithin:function(t){for(var e=0,i=this.blocks.length;i>e;e++)null!=this.blocks[e]&&this.gameState.player.inventory.count<this.gameState.player.inventory.CAP&&this.blocks[e].material==blockType.DYNAMIC&&Phaser.Rectangle.intersects(this.blocks[e].getBounds(),t)&&(this.blocks[e].destroy(),this.blocks[e]=null,this.gameState.player.inventory.change(1))}};var Player=function(t,e,i){var a=game.add.graphics(0,0);a.beginFill(3355443),a.drawRect(0,0,25,40),Phaser.Sprite.call(this,game,e,i,a.generateTexture()),a.destroy(),this.gameState=t,this.canJump=!1,this.canMove=!1,this.jumpKeyUp=!1,this.continueJump=!1,this.ACCELERATION=50,this.MAX_SPEED=300,this.JUMP=-450,this.IN_AIR_SPEED=.3,game.add.existing(this),this.create()};Player.prototype=Object.create(Phaser.Sprite.prototype),Player.prototype.constructor=Player,Player.prototype.create=function(){game.physics.p2.enable(this),this.body.mass=1,this.body.setCollisionGroup(this.gameState.playerCollisionGroup),this.inventory=new Inventory},Player.prototype.preRender=function(){this.inventory.preRender(this)},Player.prototype.update=function(){this.body.setZeroRotation(),this.body.rotation=0,this.move(),game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?this.jumpKeyUp=!1:this.jumpKeyUp=!0},Player.prototype.move=function(){var t=1;if(this.canJump||(t=this.IN_AIR_SPEED),this.canMove&&(game.input.keyboard.isDown(Phaser.Keyboard.A)||game.input.keyboard.isDown(Phaser.Keyboard.LEFT)?this.body.velocity.x+=-this.ACCELERATION*t:(game.input.keyboard.isDown(Phaser.Keyboard.D)||game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))&&(this.body.velocity.x+=this.ACCELERATION*t),this.body.velocity.x>this.MAX_SPEED&&(this.body.velocity.x=this.MAX_SPEED),this.body.velocity.x<-this.MAX_SPEED&&(this.body.velocity.x=-this.MAX_SPEED),(game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP))&&(this.canJump&&this.jumpKeyUp||this.continueJump))){this.body.velocity.y=this.JUMP,this.canJump=!1,this.continueJump=!0,game.time.events.add(Phaser.Timer.SECOND/4,this.stopJump,this).autoDestroy=!0;var e=game.add.tween(this.scale).to({x:.9,y:1.3},100,Phaser.Easing.Quadratic.In).to({x:1,y:1},100,Phaser.Easing.Quadratic.In);e.start()}},Player.prototype.stopJump=function(){this.continueJump=!1},Player.prototype.moveToStart=function(t,e){this.body.x=t,this.body.y=e,this.body.velocity.x=0,this.body.velocity.y=0},Player.prototype.checkJump=function(){this.canJump||this.doParticles(),this.canJump=!0,this.canMove=!0},Player.prototype.doParticles=function(){emitterLeft=game.add.emitter(this.body.x+20,this.body.y+this.height/2-8,200),emitterLeft.makeParticles("block"),emitterLeft.setXSpeed(0,0),emitterLeft.setYSpeed(0,0),emitterLeft.bringToTop=!0,emitterLeft.setRotation(0,0),emitterLeft.setAlpha(1,1,500),emitterLeft.setScale(.2,.25,.2,.25,500),emitterLeft.gravity=-50,emitterLeft.start(!0,300,null,2),emitterRight=game.add.emitter(this.body.x-20,this.body.y+this.height/2-8,200),emitterRight.makeParticles("block"),emitterRight.setXSpeed(0,0),emitterRight.setYSpeed(0,0),emitterRight.bringToTop=!0,emitterRight.setRotation(0,0),emitterRight.setAlpha(1,1,500),emitterRight.setScale(.2,.25,.2,.25,500),emitterRight.gravity=-50,emitterRight.start(!0,300,null,2)};var PointerController=function(t){this.gameState=t,this.graphics,this.originPointer,this.create()};PointerController.prototype={create:function(){game.input.mouse.capture=!0,this.graphics=game.add.graphics(0,0),this.graphics.alpha=.5},preRender:function(){if(this.graphics.clear(),game.input.activePointer.rightButton.isDown)null==this.originPointer&&(this.originPointer={x:game.input.x,y:game.input.y}),this.drawNet(game.input);else{if(null!=this.originPointer){var t={x:null,y:null},e={x:null,y:null};this.originPointer.x<game.input.x?(t.x=this.originPointer.x,e.x=game.input.x):(t.x=game.input.x,e.x=this.originPointer.x),this.originPointer.y<game.input.y?(t.y=this.originPointer.y,e.y=game.input.y):(t.y=game.input.y,e.y=this.originPointer.y);var i=new Phaser.Rectangle(t.x,t.y,e.x-t.x,e.y-t.y);this.gameState.map.removeBlocksWithin(i)}this.originPointer=null}},update:function(){game.input.activePointer.leftButton.isDown&&this.gameState.map.placeBlock(game.input)},drawNet:function(t){this.graphics.beginFill(16711680),this.graphics.drawRect(this.gameState.camera.x+this.originPointer.x,this.gameState.camera.y+this.originPointer.y,t.x-this.originPointer.x,t.y-this.originPointer.y)}},GameStates.Preloader=function(t){},GameStates.Preloader.prototype={preload:function(){var t=game.add.text(.2*game.width,game.world.centerY,"LOADING",textStyle.large);t.anchor.set(0,.5),game.load.json("map","../map.json"),game.load.image("block","images/block.png")},create:function(){game.state.start("MainMenu")}};var Teleporter=function(t,e,i){t+=.5,e+=.5;var a=game.add.graphics(0,0);a.beginFill(16711680),a.drawRect(0,0,i,i),Phaser.Sprite.call(this,game,t*i,e*i,a.generateTexture()),game.add.existing(this),a.destroy(),this.anchor.set(.5)};Teleporter.prototype=Object.create(Phaser.Sprite.prototype),Teleporter.prototype.constructor=Teleporter;var time,Timer=function(t,e,i){this.game=t,this.visual,this.x=e,this.y=i,this.create()};Timer.prototype={create:function(){time=0,this.visual=this.game.add.text(this.x,this.y,"0",textStyle.large),this.visual.anchor.set(.5,0),this.visual.fixedToCamera=!0},update:function(t){time+=t;var e=time/1e3;this.visual.text=e.toFixed(0).toString()}};