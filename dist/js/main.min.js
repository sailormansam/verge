var Block=function(t,e,i,a,s){e+=.5,i+=.5,this.parent=t,this.sprite,this.width=a,this.height=a,this.x=e*this.width,this.y=i*this.height,this.type=s,this.create()};Block.prototype={create:function(){var t=game.add.graphics(0,0);this.type==blockType.STATIC?t.beginFill(6710886):t.beginFill(10066329),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),game.physics.p2.enable(this.sprite),this.sprite.body.dynamic=!1,this.sprite.body.setCollisionGroup(this.parent.blockCollisionGroup),this.sprite.body.collides([this.parent.blockCollisionGroup,this.parent.playerCollisionGroup])}};var GameStates=GameStates||{},textStyle={normal:{font:"3em squada one",fill:"#333"},large:{font:"6em squada one",fill:"#333"}};GameStates.Boot=function(t){},GameStates.Boot.prototype={init:function(){this.input.maxPointers=1,game.stage.backgroundColor="#ffffff",game.canvas.oncontextmenu=function(t){t.preventDefault()}},create:function(){game.state.start("Preloader")}};var blockType={STATIC:"STATIC",MOVEABLE:"MOVEABLE"};GameStates.Editor=function(t){this.player,this.level,this.block=[],this.teleporter,this.map,this.graphics,this.originPointer,this.mapGrain=40,this.worldBottomPadding=300,this.playerCollisionGroup,this.blockCollisionGroup,this.timer,this.mapButton,this.blockLayer,this.GRAVITY=0,this.FALL_BUFFER=200},GameStates.Editor.prototype={create:function(){this.player=null,this.level=0,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.defaultRestitution=1,game.physics.p2.gravity.y=this.GRAVITY,game.physics.p2.damping=1,game.physics.p2.setImpactEvents(!0),this.playerCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockLayer=game.add.group(),this.graphics=game.add.graphics(0,0),this.graphics.alpha=.5,game.input.mouse.capture=!0,game.world.setBounds(0,0,2048,2048),this.mapButton=game.input.keyboard.addKey(Phaser.Keyboard.ENTER),this.mapButton.onDown.add(this.saveMap,this)},update:function(){game.input.activePointer.leftButton.isDown&&this.placeBlock(game.input),game.input.keyboard.isDown(Phaser.Keyboard.A)||game.input.keyboard.isDown(Phaser.Keyboard.LEFT)?game.camera.x-=5:(game.input.keyboard.isDown(Phaser.Keyboard.D)||game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))&&(game.camera.x+=5),game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?game.camera.y-=5:(game.input.keyboard.isDown(Phaser.Keyboard.S)||game.input.keyboard.isDown(Phaser.Keyboard.DOWN))&&(game.camera.y+=5)},preRender:function(){if(this.graphics.clear(),game.input.activePointer.rightButton.isDown)null==this.originPointer&&(this.originPointer={x:game.input.x,y:game.input.y}),this.drawNet(game.input);else{if(null!=this.originPointer){var t={x:null,y:null},e={x:null,y:null};this.originPointer.x<game.input.x?(t.x=this.originPointer.x,e.x=game.input.x):(t.x=game.input.x,e.x=this.originPointer.x),this.originPointer.y<game.input.y?(t.y=this.originPointer.y,e.y=game.input.y):(t.y=game.input.y,e.y=this.originPointer.y);for(var i=new Phaser.Rectangle(t.x,t.y,e.x-t.x,e.y-t.y),a=0,s=this.block.length;s>a;a++)null!=this.block[a]&&this.player.inventory.count<this.player.inventory.CAP&&this.block[a].type==blockType.MOVEABLE&&Phaser.Rectangle.intersects(this.block[a].sprite.getBounds(),i)&&(this.block[a].sprite.destroy(),this.block[a]=null,this.player.inventory.change(1))}this.originPointer=null}},placeBlock:function(t){for(var e={x:Math.floor((t.x+game.camera.x)/this.mapGrain),y:Math.floor((t.y+game.camera.y)/this.mapGrain)},i=0,a=this.block.length;a>i;i++)if(null!=this.block[i]&&this.block[i].x==(e.x+.5)*this.mapGrain&&this.block[i].y==(e.y+.5)*this.mapGrain)return;var s=new Block(this,e.x,e.y,this.mapGrain,blockType.MOVEABLE);this.block.push(s),this.blockLayer.add(s.sprite)},drawNet:function(t){this.graphics.beginFill(16711680),this.graphics.drawRect(this.camera.x+this.originPointer.x,this.camera.y+this.originPointer.y,t.x-this.originPointer.x,t.y-this.originPointer.y)},saveMap:function(){for(var t=[],e=0,i=this.block.length;i>e;e++)t.push({type:"STATIC",x:this.block[e].x,y:this.block[e].y});console.log(JSON.stringify({block:t}))}};var blockType={STATIC:"STATIC",MOVEABLE:"MOVEABLE"};GameStates.Game=function(t){this.player,this.level,this.block=[],this.teleporter,this.map,this.graphics,this.originPointer,this.mapGrain=40,this.worldBottomPadding=300,this.playerCollisionGroup,this.blockCollisionGroup,this.timer,this.blockLayer,this.GRAVITY=1e3,this.FALL_BUFFER=200},GameStates.Game.prototype={create:function(){this.player=null,this.level=0,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.defaultRestitution=1,game.physics.p2.gravity.y=this.GRAVITY,game.physics.p2.damping=1,game.physics.p2.setImpactEvents(!0),this.playerCollisionGroup=game.physics.p2.createCollisionGroup(),this.blockCollisionGroup=game.physics.p2.createCollisionGroup(),this.map=JSON.parse(JSON.stringify(game.cache.getJSON("map"))),this.blockLayer=game.add.group(),this.graphics=game.add.graphics(0,0),this.graphics.alpha=.5,this.makeLevel(this.level),game.input.mouse.capture=!0,this.player.sprite.body.collides(this.blockCollisionGroup,this.player.checkJump,this.player),this.timer=new Timer(game,game.width-60,20)},update:function(){this.player.update(),this.timer.update(game.time.elapsedMS),game.input.activePointer.leftButton.isDown&&this.placeBlock(game.input),Phaser.Rectangle.intersects(this.player.sprite.getBounds(),this.teleporter.sprite.getBounds())&&(this.map.level[this.level+1]?(this.makeLevel(this.level++),this.player.canMove=!1):game.state.start("GameOver")),this.player.sprite.body.y>game.world.height+this.worldBottomPadding+this.player.sprite.height&&this.makeLevel(this.level)},preRender:function(){if(this.player.preRender(),this.graphics.clear(),game.input.activePointer.rightButton.isDown)null==this.originPointer&&(this.originPointer={x:game.input.x,y:game.input.y}),this.drawNet(game.input);else{if(null!=this.originPointer){var t={x:null,y:null},e={x:null,y:null};this.originPointer.x<game.input.x?(t.x=this.originPointer.x,e.x=game.input.x):(t.x=game.input.x,e.x=this.originPointer.x),this.originPointer.y<game.input.y?(t.y=this.originPointer.y,e.y=game.input.y):(t.y=game.input.y,e.y=this.originPointer.y);for(var i=new Phaser.Rectangle(t.x,t.y,e.x-t.x,e.y-t.y),a=0,s=this.block.length;s>a;a++)null!=this.block[a]&&this.player.inventory.count<this.player.inventory.CAP&&this.block[a].type==blockType.MOVEABLE&&Phaser.Rectangle.intersects(this.block[a].sprite.getBounds(),i)&&(this.block[a].sprite.destroy(),this.block[a]=null,this.player.inventory.change(1))}this.originPointer=null}},placeBlock:function(t){for(var e={x:Math.floor((t.x+game.camera.x)/this.mapGrain),y:Math.floor((t.y+game.camera.y)/this.mapGrain)},i=0,a=this.block.length;a>i;i++)if(null!=this.block[i]&&this.block[i].x==(e.x+.5)*this.mapGrain&&this.block[i].y==(e.y+.5)*this.mapGrain)return;if(this.player.inventory.count>0){var s=new Block(this,e.x,e.y,this.mapGrain,blockType.MOVEABLE);this.block.push(s),this.blockLayer.add(s.sprite),this.player.inventory.change(-1)}},drawNet:function(t){this.graphics.beginFill(16711680),this.graphics.drawRect(this.camera.x+this.originPointer.x,this.camera.y+this.originPointer.y,t.x-this.originPointer.x,t.y-this.originPointer.y)},makeLevel:function(){game.world.alpha=0,this.block.forEach(function(t){null!=t&&t.sprite.destroy()}),this.block=[],this.teleporter&&this.teleporter.sprite.destroy(),this.player?this.player.moveToStart(this.map.level[this.level].start.x*this.mapGrain+.5,this.map.level[this.level].start.y*this.mapGrain+.5):this.player=new Player(this,this.map.level[this.level].start.x*this.mapGrain+.5,this.map.level[this.level].start.y*this.mapGrain+.5),this.player.inventory.clear();for(var t=0,e=this.map.level[this.level].block.length;e>t;t++)this.block.push(new Block(this,this.map.level[this.level].block[t].x,this.map.level[this.level].block[t].y,this.mapGrain,this.map.level[this.level].block[t].type));this.teleporter=new Teleporter(this.map.level[this.level].teleporter.x,this.map.level[this.level].teleporter.y,this.mapGrain);for(var i=0,a=0,t=0,e=this.block.length;e>t;t++)this.block[t].x>i&&(i=this.block[t].x),this.block[t].y>a&&(a=this.block[t].y);i<game.width&&(i=game.width),a<game.height&&(a=game.height),game.world.setBounds(0,0,i+this.mapGrain/2,a+this.FALL_BUFFER),game.camera.follow(null),game.camera.x=20,game.add.tween(game.world).to({alpha:1},500).start();var s=game.add.tween(game.camera).to({x:0},300);s.start(),s.onComplete.add(function(){game.camera.follow(this.player.sprite)},this)}},GameStates.GameOver=function(t){},GameStates.GameOver.prototype={create:function(){this.titleText=game.add.text(.25*game.width,.5*game.height,"TIME "+(time/1e3).toFixed(0).toString(),textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY AGAIN",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0);var t=game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);t.onComplete.add(function(){game.state.start("Game")},this)}};var Inventory=function(t){this.isEditor=t,this.isEditor?(this.count=512,this.CAP=512):(this.count=0,this.CAP=5),this.sprite=null,this.blockWidth=20,this.blockHeight=20,this.x=0,this.y=0,this.paddingX=-20,this.paddingY=-45,this.create()};Inventory.prototype={create:function(){this.isEditor||this.drawCount()},preRender:function(t){this.isEditor||(this.x=t.sprite.body.x,this.y=t.sprite.body.y,this.positionSprite())},change:function(t){this.count+=t,this.drawCount()},clear:function(){this.count=0,this.drawCount()},drawCount:function(){this.sprite&&this.sprite.destroy();var t=game.add.graphics(0,0);t.beginFill(10066329);for(var e=0;e<this.count;e++)t.drawRect(e*(this.blockWidth+5),0,this.blockWidth,this.blockHeight);this.sprite=game.add.sprite(this.x+this.paddingX,this.y+this.paddingY,t.generateTexture()),this.positionSprite(),t.destroy()},positionSprite:function(){var t=this.sprite.width||0;this.sprite.x=this.x+this.paddingX-t,this.sprite.y=this.y+this.paddingY}},GameStates.MainMenu=function(t){this.titleText,this.playText,this.editor},GameStates.MainMenu.prototype={create:function(){this.titleText=game.add.text(.25*game.width,game.world.centerY,"VERGE",textStyle.large),this.titleText.anchor.set(0,.5),this.titleText.alpha=0,this.playText=game.add.text(.25*game.width,.625*game.height,"PLAY",textStyle.normal),this.playText.anchor.set(0,.5),this.playText.alpha=0,this.editor=game.add.text(.25*game.width,.7*game.height,"EDITOR",textStyle.normal),this.editor.anchor.set(0,.5),this.editor.alpha=0,game.add.tween(this.titleText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200),game.add.tween(this.editor).to({alpha:1,x:.2*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400),this.playText.inputEnabled=!0,this.playText.input.useHandCursor=!0,this.playText.events.onInputDown.add(this.play,this),this.editor.inputEnabled=!0,this.editor.input.useHandCursor=!0,this.editor.events.onInputDown.add(this.playEditor,this)},play:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);var t=game.add.tween(this.editor).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400);t.onComplete.add(function(){game.state.start("Game")},this)},playEditor:function(){game.add.tween(this.titleText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0),game.add.tween(this.playText).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,200);var t=game.add.tween(this.editor).to({alpha:0,x:.15*game.width},500,Phaser.Easing.Quadratic.InOut,!0,400);t.onComplete.add(function(){game.state.start("Editor")},this)}};var Player=function(t,e,i,a){this.parent=t,this.sprite,this.x=e,this.y=i,this.width=25,this.height=40,this.canJump=!1,this.canMove=!1,this.jumpKeyUp=!1,this.continueJump=!1,this.isEditor=a,this.ACCELERATION=50,this.MAX_SPEED=300,this.JUMP=-450,this.IN_AIR_SPEED=.3,this.create()};Player.prototype={create:function(){var t=game.add.graphics(0,0);t.beginFill(3355443),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),game.physics.p2.enable(this.sprite),this.sprite.body.mass=1,this.sprite.body.setCollisionGroup(this.parent.playerCollisionGroup),this.inventory=new Inventory(this.isEditor)},preRender:function(){this.inventory.preRender(this)},update:function(){this.sprite.body.setZeroRotation(),this.sprite.body.rotation=0,this.move(),game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?this.jumpKeyUp=!1:this.jumpKeyUp=!0},move:function(){var t=1;if(this.canJump||(t=this.IN_AIR_SPEED),this.canMove||this.isEditor)if(game.input.keyboard.isDown(Phaser.Keyboard.A)||game.input.keyboard.isDown(Phaser.Keyboard.LEFT)?this.sprite.body.velocity.x+=-this.ACCELERATION*t:(game.input.keyboard.isDown(Phaser.Keyboard.D)||game.input.keyboard.isDown(Phaser.Keyboard.RIGHT))&&(this.sprite.body.velocity.x+=this.ACCELERATION*t),this.sprite.body.velocity.x>this.MAX_SPEED&&(this.sprite.body.velocity.x=this.MAX_SPEED),this.sprite.body.velocity.x<-this.MAX_SPEED&&(this.sprite.body.velocity.x=-this.MAX_SPEED),this.isEditor)game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP)?this.sprite.body.velocity.y+=-this.ACCELERATION*t:(game.input.keyboard.isDown(Phaser.Keyboard.S)||game.input.keyboard.isDown(Phaser.Keyboard.DOWN))&&(this.sprite.body.velocity.y+=this.ACCELERATION*t),this.sprite.body.velocity.y>this.MAX_SPEED&&(this.sprite.body.velocity.y=this.MAX_SPEED),this.sprite.body.velocity.y<-this.MAX_SPEED&&(this.sprite.body.velocity.y=-this.MAX_SPEED);else if((game.input.keyboard.isDown(Phaser.Keyboard.W)||game.input.keyboard.isDown(Phaser.Keyboard.UP))&&(this.canJump&&this.jumpKeyUp||this.continueJump)){this.sprite.body.velocity.y=this.JUMP,this.canJump=!1,this.continueJump=!0,game.time.events.add(Phaser.Timer.SECOND/4,this.stopJump,this).autoDestroy=!0;var e=game.add.tween(this.sprite.scale).to({x:.9,y:1.3},100,Phaser.Easing.Quadratic.In).to({x:1,y:1},100,Phaser.Easing.Quadratic.In);e.start()}},stopJump:function(){this.continueJump=!1},moveToStart:function(t,e){this.sprite.body.x=t,this.sprite.body.y=e,this.sprite.body.velocity.x=0,this.sprite.body.velocity.y=0},checkJump:function(){this.canJump||this.doParticles(),this.canJump=!0,this.canMove=!0},doParticles:function(){emitterLeft=game.add.emitter(this.sprite.body.x+20,this.sprite.body.y+this.sprite.height/2-8,200),emitterLeft.makeParticles("block"),emitterLeft.setXSpeed(0,0),emitterLeft.setYSpeed(0,0),emitterLeft.bringToTop=!0,emitterLeft.setRotation(0,0),emitterLeft.setAlpha(1,1,500),emitterLeft.setScale(.2,.25,.2,.25,500),emitterLeft.gravity=-50,emitterLeft.start(!0,300,null,2),emitterRight=game.add.emitter(this.sprite.body.x-20,this.sprite.body.y+this.sprite.height/2-8,200),emitterRight.makeParticles("block"),emitterRight.setXSpeed(0,0),emitterRight.setYSpeed(0,0),emitterRight.bringToTop=!0,emitterRight.setRotation(0,0),emitterRight.setAlpha(1,1,500),emitterRight.setScale(.2,.25,.2,.25,500),emitterRight.gravity=-50,emitterRight.start(!0,300,null,2)}},GameStates.Preloader=function(t){},GameStates.Preloader.prototype={preload:function(){var t=game.add.text(.2*game.width,game.world.centerY,"LOADING",textStyle.large);t.anchor.set(0,.5),game.load.json("map","../map.json"),game.load.image("block","images/block.png")},create:function(){game.state.start("MainMenu")}};var Teleporter=function(t,e,i){t+=.5,e+=.5,this.sprite,this.width=i,this.height=i,this.x=t*this.width,this.y=e*this.height,this.create()};Teleporter.prototype={create:function(){var t=game.add.graphics(0,0);t.beginFill(16711680),t.drawRect(0,0,this.width,this.height),this.sprite=game.add.sprite(this.x,this.y,t.generateTexture()),t.destroy(),this.sprite.anchor.set(.5)}};var time,Timer=function(t,e,i){this.game=t,this.visual,this.x=e,this.y=i,this.create()};Timer.prototype={create:function(){time=0,this.visual=this.game.add.text(this.x,this.y,"0",textStyle.large),this.visual.anchor.set(.5,0),this.visual.fixedToCamera=!0},update:function(t){time+=t;var e=time/1e3;this.visual.text=e.toFixed(0).toString()}};